# This is the SAM template that represents the architecture of your serverless application
# https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-template-basics.html

AWSTemplateFormatVersion: 2010-09-09
Description: my-test-app
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Timeout: 100
    MemorySize: 128
    Runtime: nodejs14.x
    Handler: index.handler
    Environment:
      Variables:
        MY_TASKS_TABLE:
          Ref: MyTasksTable
Resources:
  GetUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/user/get-user/
      Description: A Lambda function that returns a user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref UserLayer
        - !Ref GenericLayer
      Events:
        GetUserApi:
          Type: Api
          Properties:
            Method: GET
            Path: /users/{userId}
  CreateUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/user/create-user/
      Description: A Lambda function that creates a user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref UserLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: POST
            Path: /users
  PatchUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/user/patch-user/
      Description: A Lambda function that patches a user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref UserLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: PATCH
            Path: /users/{userId}
  DeleteUserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/user/delete-user/
      Description: A Lambda function that delete a user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref UserLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: DELETE
            Path: /users/{userId}
  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/login/
      Description: A Lambda function that logs in a user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref UserLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: POST
            Path: /auth/signin
  CreateListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/list/create-list/
      Description: A Lambda function that creates a list for the specified user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref ListLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: POST
            Path: /users/{userId}/lists
  GetListsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/list/get-lists/
      Description: A Lambda function that gets the lists of the specified user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref ListLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: GET
            Path: /users/{userId}/lists/
  DeleteListFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/list/delete-list/
      Description: A Lambda function that delete a list of the specified user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref ListLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: DELETE
            Path: /users/{userId}/lists/{listId}
  CreateTaskFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: functions/task/create-task/
      Description: A Lambda function that creates a task for the specified user
      Policies:
        - DynamoDBCrudPolicy:
            TableName: MyTasksTable
      Layers:
        - !Ref DynamoLayer
        - !Ref TaskLayer
        - !Ref GenericLayer
      Events:
        CreateUserApi:
          Type: Api
          Properties:
            Method: POST
            Path: /lists/{listId}/tasks
  DynamoLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: DynamoLayer
      Description: Dependency for DynamoDB related functions
      ContentUri: layers/dynamo-layer
      CompatibleRuntimes:
        - nodejs14.x
    Metadata:
      BuildMethod: nodejs14.x
  ListLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: ListLayer
      Description: Dependency for List Model related functions
      ContentUri: layers/list-layer
      CompatibleRuntimes:
        - nodejs14.x
    Metadata:
      BuildMethod: nodejs14.x
  TaskLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: TaskLayer
      Description: Dependency for Task Model related functions
      ContentUri: layers/task-layer
      CompatibleRuntimes:
        - nodejs14.x
    Metadata:
      BuildMethod: nodejs14.x
  UserLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: UserLayer
      Description: Dependency for User Model related functions
      ContentUri: layers/user-layer
      CompatibleRuntimes:
        - nodejs14.x
    Metadata:
      BuildMethod: makefile
  GenericLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: GenericLayer
      Description: Dependency for Generic functions
      ContentUri: layers/generic-layer
      CompatibleRuntimes:
        - nodejs14.x
    Metadata:
      BuildMethod: nodejs14.x
  MyTasksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: MyTasksTable
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: user-email-index
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: KEYS_ONLY
